name: Test

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    container:
      image: golang:1.21
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create non-root user
        run: |
          useradd -m testuser
          chown -R testuser:testuser .
          chown -R testuser:testuser /go
          mkdir -p /home/testuser/.cache
          chown -R testuser:testuser /home/testuser

      - name: Check formatting
        run: su testuser -c 'gofmt -l . | grep . && exit 1 || exit 0'

      - name: Run vet
        run: su testuser -c 'HOME=/home/testuser go vet ./...'

      - name: Run tests
        run: su testuser -c 'HOME=/home/testuser go test -v -race -coverprofile=coverage.out ./...'
